# Example pod.yml for launching feed

# listen directly on host interface
hostNetwork: true

# time to wait for requests to gracefully terminate when updating the controller
terminationGracePeriodSeconds: 30

# always restart on death
restartPolicy: Always

containers:
- image: skycirrus/feed-ingress:latest
  name: feed-ingress

  resources:
    requests:
      cpu: 2000m
      memory: 200Mi
    limits:
      memory: 200Mi

  ports:
  - hostPort: 8080
    containerPort: 8080
    name: ingress
    protocol: TCP
  - hostPort: 8081
    containerPort: 8081
    name: ingress-health
    protocol: TCP
  - containerPort: 12082
    name: health
    protocol: TCP

  args:
  - -apiserver=https://$(KUBERNETES_SERVICE_HOST):$(KUBERNETES_SERVICE_PORT)
  - -cacertfile=/run/secrets/kubernetes.io/serviceaccount/ca.crt
  - -tokenfile=/run/secrets/kubernetes.io/serviceaccount/token
  - -ingress-port=8080
  - -ingress-health-port=8081
  - -ingress-allow=10.0.0.0/8
  - -health-port=12082
  - -nginx-loglevel=crit

  # metrics settings
  - -pushgateway=http://pushgateway.sky
  - -pushgateway-interval=20
  - -pushgateway-label=k8s_cluster=dev
  - -pushgateway-label=version=0.1.0

  # sky.uk/KubernetesClusterFrontend tag value to find ELBs
  - -elb-label-value=dev
  - -elb-expected-number=2

  # each worker uses a full cpu, so scale up vertically on a box by increasing this value
  - -nginx-workers=2

  # connections*workers needs to be less than available ephemeral ports. centos7 default: 60999-32768=28231
  - -nginx-worker-connections=10000

  # needs to be greater than the ELB idle timeout, see `aws_provisioning/roles/kubernetes` for ELB value
  - -nginx-keepalive-seconds=304

  # CIDRs of the ELBs to trust X-Forwarded-For, for determining client IP allow/deny
  - -nginx-trusted-frontends=10.10.10.0/24

  # max number of idle connections to a backend
  - -nginx-backend-keepalive-count=1024

  # max time for a keepalive connection to a backend, should be less than backend idle timeouts. e.g. 30s for dropwizard
  - -nginx-default-backend-keepalive-seconds=28

  # needs to be greater than 64 to support our very large domain names
  - -nginx-server-names-hash-bucket-size=128

  # access logs are turned on, remove the "-access-log" flag to turn them off
  - -access-log
  - -access-log-dir=/var/log/nginx

  # headers to output in access logs
  - -nginx-log-headers=Authorization,Content-Type

  # controller health determines readiness
  readinessProbe:
    httpGet:
      path: /health
      port: 12082
      scheme: HTTP
    initialDelaySeconds: 1
    timeoutSeconds: 1
    periodSeconds: 1
    failureThreshold: 1

  # only consider liveness of ingress itself, favouring uptime over controller health
  livenessProbe:
    httpGet:
      path: /health
      port: 8081
      scheme: HTTP
    initialDelaySeconds: 30
    timeoutSeconds: 1
    # kill if failing for 30 seconds
    periodSeconds: 10
    failureThreshold: 3

  env:
   - name: HTTP_PROXY
     value: http://proxy
   - name: NO_PROXY
     value: ignore

  volumeMounts:
  - name: nginx-log
    mountPath: /var/log/nginx

volumes:
- name: nginx-log
  emptyDir: {}
